
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <title>Partida</title>
    <script
  src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"
  type="module"
></script>

    <style>

        body {         
            background-color: #000000c8;
            color: #ffffff;
            font-family: Ubuntu, sans-serif;
        }
        .game-container{
            border: 2px solid #ccc;
            border-radius: 20px;
            max-width: 1200px;
            margin: 15px auto;
            padding: 20px;
            text-align: center;
        }

        .top-bar {
            display: flex;
            justify-content:center;
            align-items: center;
        }

        

        .titulo {
            font-size: 28px;
            margin-bottom: 20px;

        }

        .painel{
            display: flex;
            justify-content: space-between;
        }

        .painel-jogador{
            border: 2px solid #ccc;
            border-radius: 20px;
            padding: 20px;
            width: 200px;
            padding: 15px;
        }

        .avatar{
            width: 100px;
            height: 100px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
        }

        .info-nome{
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 4px 10px;
            margin-bottom: 15px;
        }

        .info-id{
            font-size: 12px;
            margin-bottom: 65px;
        }

        .simbolo{
            font-size: 50px;
            margin-bottom: 65px;
        }

        .raking{
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-size: 16px;
        }

        .raking span:first-child{
            font-size: 12px;
            margin-right: 10px;
            color: #e4e4de
        }
        .raking span:last-child{
            font-size: 20px;
            color: silver;
        }

        .tabuleiro{
            display: grid;
            grid-template-columns: repeat(3, 130px);
            grid-template-rows: repeat(3, 130px);            
            align-items: center;
            justify-items: center;
            margin: 0 20px;
        }

        .celula{
            width: 130px;
            height: 130px;
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
        }

        .celula:hover{
            background-color: #fffae681;
            cursor: pointer;
        }

        .celula:nth-child(1),
        .celula:nth-child(2),
        .celula:nth-child(4),
        .celula:nth-child(5){
            border-right: 3px solid #ccc;
            border-bottom: 3px solid #ccc;
        }

        .celula:nth-child(3),
        .celula:nth-child(6){
            border-bottom: 3px solid #ccc;
        }
        
       

        .celula:nth-child(7),
        .celula:nth-child(8){
            border-right: 3px solid #ccc;
        } 

        .rodape{
            margin-top: 30px;

        }

        .cronometro{
            font-size: 20px;         
        }

        .modo{
            font-size: 18px;
            margin-top: 5px;
        }

        .rodape .espectadores {
            font-size: 28px;      
        }

    #modal-loading{
      display:none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(231, 219, 219, 0.5);
      z-index: 1000;

      display: flex;
      justify-content: center;
      align-items: center;
    }

    #modal-loading .modal-content {
  /* garante que o conteúdo interno também esteja alinhado em coluna */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;

  /* opcional: dá um fundo branco e borda para destacar melhor */
  background: #fff;
  padding: 1.5rem;
  border-radius: 8px;
}

/* forçar texto em preto para todo o conteúdo da modal */
#modal-loading .modal-content h2,
#modal-loading .modal-content p {
  color: #000;
}

    </style>
</head>
<body>
    <div class="game-container">
        <div class="top-bar">           
            <div class="titulo">Sua vez</div>            
        </div>

        <div class="painel">
            <div class="painel-jogador">
                <div class="avatar">JR</div>
                <div class="info-nome">Player 1</div>
                <div class="info-id">ID: 12324</div>
                <div class="simbolo">X</div>
                <div class="raking">
                    <span>Prata</span>
                    <span>10</span>
                </div>
            </div>

             <div class="tabuleiro">
                <div class="celula" id="celula-1" data-posicao="1"></div>
                <div class="celula" id="celula-2" data-posicao="2"></div>
                <div class="celula" id="celula-3" data-posicao="3"></div>
                <div class="celula" id="celula-4" data-posicao="4"></div>
                <div class="celula" id="celula-5" data-posicao="5"></div>
                <div class="celula" id="celula-6" data-posicao="6"></div>
                <div class="celula" id="celula-7" data-posicao="7"></div>
                <div class="celula" id="celula-8" data-posicao="8"></div>
                <div class="celula" id="celula-9" data-posicao="9"></div>

            </div> 

            <div class="painel-jogador">
                <div class="avatar">CS</div>
                <div class="info-nome">Player 2</div>
                <div class="info-id">ID: 564634</div>
                <div class="simbolo">O</div>
                <div class="raking">
                    <span>Gold</span>
                    <span>3</span>
                </div>
            </div>
        </div>    
        
        <div class="rodape">
            <div class="cronometro">
                Cronômetro: 00:00:00
              </div>
              <div class="modo">
                Ranqueada
              </div>
              <div class="espectadores">1 </div>

            </div>
        </div>
    </div> 

    <div id="modal-loading" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Carregando...</h2>
            <dotlottie-player
                src="https://lottie.host/d82375e5-f5c7-4e71-8344-db475c09038f/1Q3yZQbZri.lottie"
                background="transparent"
                speed="1"
                style="width: 300px; height: 300px"
                loop
                autoplay
                ></dotlottie-player>
            <p>Aguarde enquanto a partida é carregada.</p>
        </div>
    </div>
</body>
</html>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    const id_player1 = 1; // ID do jogador 1
    const id_player2 = 2; // ID do jogador 2
    let ultimoJogador = null; // Começa com o jogador 1    


    //TODO: 2.a Criar uma função que é executada a cada 1 segundo
    //e realiza um request para o endpoint "/api/v1/partida/:id_partida/historico"
    //a partir do retorno verifica se a jogada foi realizada pelo jogador logado.
    //caso não seja, exibe um alerta informando que é a vez do outro jogador.
    //caso seja, atualiza o tabuleiro com a jogada realizada pelo outro jogador.
    //e debloqueia o tabuleiro para que o jogador atual possa realizar a jogada.




    $(document).ready(function() { 
<<<<<<< HEAD

        // Popular dados do jogador
        //popularDadosJogador();

=======
>>>>>>> 3dc5e6a9fa6e8511322f48cb44b2bbbe542ada09
        //TODO: 1.b realizar uma chamada para a api no endpoint "/api/v1/partida/em-andamento"
        //para verificar se existe uma partida em andamento
        //caso não exista, realizar uma chamada para o endpoint "/api/v1/partida" realizando a criação da partida e ingressar o usuário atual na partida criada.
        //caso exista, realizar uma chamada para o endpoint "/api/v1/partida/:id_partida" realizando a atualização do status da partida e ingressar o usuário atual na partida existente.


       

        $(".celula").click(function() { 
            const jogadorAtual = definirJogador();
            const simbolo = obterSimbilo(jogadorAtual);

            let posicao = $(this).data("posicao");
            //alert(`Você clicou na célula ${posicao}`);            

            let valor = $(this).text();
            if (valor == "") {
            //TODO: realizar um request para "/api/v1/partidaHistorico" para persistir a jogada atual no servidor
                $(this).text(simbolo);
                //$(this).css("color", "red");
            } else {
                alert("Essa célula já foi preenchida!");
            }

            verificarVitoria();
        });
    });

    function verificarVitoria(){
        const combinacoes = [
            [1, 2, 3],
            [4, 5, 6],
            [7, 8, 9],
            [1, 4, 7],
            [2, 5, 8],
            [3, 6, 9],
            [1, 5, 9],
            [3, 5, 7]
        ];	

        for (let i = 0; i < combinacoes.length; i++) {
            const [a, b, c] = combinacoes[i];
            const celulaA = $(`#celula-${a}`).text();
            const celulaB = $(`#celula-${b}`).text();
            const celulaC = $(`#celula-${c}`).text();

            if (celulaA === celulaB && celulaB === celulaC && celulaA !== "") {
                //alert(`Jogador ${jogadorAtual} venceu!`);
                Swal.fire({
                        title: `Jogador ${ultimoJogador} venceu!`,
                        icon: "success"
                    });
                return;
            }
        }
    }

    function definirJogador(){
        if(ultimoJogador == id_player1){
            ultimoJogador = id_player2;
        }else{
            ultimoJogador = id_player1;
        }
        return ultimoJogador;
    }

    function obterSimbilo(id_jogador){
        if(id_jogador == id_player1){
            return "X";
        }else{
            return "O";
        }
    }



function popularDadosJogador(jogador){
    const usuario = JSON.parse(localStorage.getItem("usuario"));    
    if (usuario) {

        const avatar = criarAvatar(usuario.nome); // Exemplo: JR
        $(`.avatar:${jogador}`).text(avatar); // Exemplo: JR
        $(`.avatar:${jogador}`).css("background-color", gerarCorAvatar())

        $(`.info-nome:${jogador}`).text(usuario.nome); // Exemplo: Player 1
        $(`.info-id:${jogador}`).text(`ID: ${usuario.id}`); // Exemplo: ID: 12324
        $(`.simbolo:${jogador}`).text("X"); // Exemplo: X ou O
        $(`.raking:${jogador} span:last-child`).text("---"); // Exemplo: 10
    } else {
        console.error("Usuário não encontrado no localStorage.");
    }
}
 
 function criarAvatar(nome){
    const nomes = nome.split(" ");
    const avatar = `${nomes[0][0].toUpperCase()}${nomes[nomes.length - 1][0].toUpperCase()}`;
    console.log(avatar);
    return avatar; 
 }

 function gerarCorAvatar(){
    const red = getRandomInt(80, 255);
    const green = getRandomInt(80, 255);
    const blue = getRandomInt(80, 255);
    return `rgb(${red}, ${green}, ${blue})`;
 }

 function getRandomInt(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min) + min);
}

function toggleModalLoading() {
    const modal = $("#modal-loading");
    if (modal.is(":visible")) {
        modal.hide();
    } else {
        modal.show();
    }
}

function verificarSeExistePartidaEmAndamento() {
    $.ajax({
        url: "/api/v1/partida/em-andamento",
        method: "GET",
        success: function(response) {
            if (response.length > 0) {
                // Partida em andamento, atualizar o status e ingressar o usuário
                console.log("Partida em andamento:", response);
                
                processarPartidaEmAndamento(response);
                // Aqui você pode chamar a função para atualizar o status da partida e ingressar o usuário
            } else {
                // Nenhuma partida em andamento, criar uma nova partida
                console.log("Nenhuma partida em andamento, criando uma nova partida.");
                toggleModalLoading();
                criarNovaPartida();
            }
        },
        error: function(xhr) {
            console.error("Erro ao verificar partida em andamento:", xhr);
            Swal.fire({
                title: "Erro ao verificar partida em andamento.",
                icon: "error"
            });
        }
    });
}

function criarNovaPartida() {

    const usuarioLogado = JSON.parse(localStorage.getItem("usuario"));
    if (!usuarioLogado) {
        Swal.fire({
            title: "Usuário não encontrado.",
            icon: "error"
        });
        return;
    }

    const dados ={
        id_usuario: usuarioLogado.id
    };

    $.ajax({
        url: "/api/v1/partida",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(dados),
        success: function(response) {
            console.log("Partida criada com sucesso:", response);
            localStorage.setItem("partida", JSON.stringify(response));
            Swal.fire({
                title: "Partida criada com sucesso!",
                icon: "success"
            });
            toggleModalLoading();
        },
        error: function(xhr) {
            console.error("Erro ao criar nova partida:", xhr);
            Swal.fire({
                title: "Erro ao criar nova partida.",
                icon: "error"
            });
            toggleModalLoading();
        }
    });
}

function processarPartidaEmAndamento(partidas) {
    const usuarioLogado = JSON.parse(localStorage.getItem("usuario"));
    const partida = JSON.parse(localStorage.getItem("partida"));

    if(partidas[0].id_usuario_a != usuarioLogado.id && 
       partidas[0].id_usuario_b != usuarioLogado.id){
        // O usuário logado não está na partida
        console.log("Usuário logado não está na partida.");
        buscarDadosUsuario(usuarioLogado.id);
        return;
    }

    if(partidas[0].id_usuario_a == usuarioLogado.id){
        // O usuário logado é o jogador A
        popularDadosJogador("first");
        console.log("Usuário logado é o jogador A:", usuarioLogado);
    } else if(partidas[0].id_usuario_b == usuarioLogado.id){
        // O usuário logado é o jogador B
        popularDadosJogador("last");
        console.log("Usuário logado é o jogador B:", usuarioLogado);
    } else {
        // O usuário logado não está na partida
        ingressarUsuarioNaPartida(partidas[0].id, usuarioLogado.id);        
        popularDadosJogador("last");
        console.log("Usuário logado não está na partida.");
        return;
    }
    // Aqui você pode processar a partida em andamento, por exemplo, atualizando o status ou ingressando o usuário
    console.log("Processando partida em andamento:", partida);
}

function ingressarUsuarioNaPartida(idPartida, idUsuario){
    const dados = {
        id_partida: idPartida,
        id_usuario_b: idUsuario
    };

    $.ajax({
        url: `/api/v1/partida/${idPartida}`,
        method: "PUT",
        contentType: "application/json",
        data: JSON.stringify(dados),
        success: function(response) {
            console.log("Usuário ingressou na partida com sucesso:", response);
            localStorage.setItem("partida", JSON.stringify(response));
            Swal.fire({
                title: "Usuário ingressou na partida com sucesso!",
                icon: "success"
            });
        },
        error: function(xhr) {
            console.error("Erro ao ingressar usuário na partida:", xhr);
            Swal.fire({
                title: "Erro ao ingressar usuário na partida.",
                icon: "error"
            });
        }
    });
}


function buscarDadosUsuario(idUsuario) {
    $.ajax({
        url: `/api/v1/usuario/${idUsuario}`,
        method: "GET",
        success: function(response) {
            console.log("Dados do usuário:", response);
            localStorage.setItem("usuarioAdversario", JSON.stringify(response));            
        },
        error: function(xhr) {
            console.error("Erro ao buscar dados do usuário:", xhr);
            Swal.fire({
                title: "Erro ao buscar dados do usuário.",
                icon: "error"
            });
        }
    });
}

</script>
